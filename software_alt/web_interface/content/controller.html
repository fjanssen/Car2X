<!DOCTYPE html><html>
<title> SafetyCar controller </title>
<body>
<div id="help1" style="position:fixed; left:40%; top:4%; color:grey;">
   Use touchscreen to control speed (up, down) and steering (left, right).
</div>
<div id="help2" style="position:fixed; left:40%; top:8%; color:grey;">
   Controlling by keyboard (W A S D) is available. To stop car immediate, press x.
</div>

<div id="speedinfo" style="position:fixed; left:5%; top:4%; color:grey;">
   Frontal speed:
</div>

<div id="steeringinfo" style="position:fixed; left:5%; top:8%; color:grey;">
   Steering:
</div>

<div id="distaheadinfo" style="position:fixed; left:5%; top:12%; color:grey;">
   Free distance ahead:
</div>

<div id="distbackinfo" style="position:fixed; left:5%; top:16%; color:grey;">
   Free distance back:
</div>

<script src="three.min.js"></script>
<script src="threex.keyboardstate.js"></script>
<script src="virtualjoystick.js"></script>
<script>
var scene = new THREE.Scene();
var camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
var clock = new THREE.Clock();

var keyboard = new THREEx.KeyboardState();
var joystick = new VirtualJoystick({
mouseSupport	: true,
limitStickTravel: true,
stickRadius	: 250,
stationaryBase	: true,
baseX	: 275,
baseY	: 275
});

var renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);
window.addEventListener('resize', onWindowResize, false);

var cubeGeometry = new THREE.CubeGeometry(40,60,15);
var cubeMaterial = new THREE.MeshLambertMaterial({ color: 'rgb(0,255,0)' });
var cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
scene.add(cube);

var frontObstacleGeometry = new THREE.CubeGeometry(60,10,15);
var frontObstacleMaterial = new THREE.MeshLambertMaterial({ color: 'rgb(255,0,0)' });
var frontObstacle = new THREE.Mesh(frontObstacleGeometry, frontObstacleMaterial);
scene.add(frontObstacle);

var backObstacleGeometry = new THREE.CubeGeometry(60,10,15);
var backObstacleMaterial = new THREE.MeshLambertMaterial({ color: 'rgb(255,0,0)' });
var backObstacle = new THREE.Mesh(backObstacleGeometry, backObstacleMaterial);
scene.add(backObstacle);

var light = new THREE.HemisphereLight(0xF0F0F0, 0x404040 , 1);
scene.add(light);

var frameTime = 0;

camera.position.y = 40;
camera.position.z = 160;

cube.rotation.x = 0.0;
cube.rotation.y = 0.0;

// Text vars
var speedText = document.getElementById("speedinfo");
var steeringText = document.getElementById("steeringinfo");
var distaheadText = document.getElementById("distaheadinfo");
var distbackText = document.getElementById("distbackinfo");

var speed = 0;
var left = 100;
var right = 100;
var front = 4000;
var back = 4000;

sent = "true";

animate();






// Connection
function loadXMLDoc()
{
	sent = "false";
	var xmlHttpObject = false;
	// Überprüfen ob XMLHttpRequest-Klasse vorhanden und erzeugen von Objekte für IE7, Firefox, etc.
	if (typeof XMLHttpRequest != 'undefined') 
	xmlHttpObject = new XMLHttpRequest();

	// Wenn im oberen Block noch kein Objekt erzeugt, dann versuche XMLHTTP-Objekt zu erzeugen
	// Notwendig für IE6 oder IE5
	if (!xmlHttpObject) 
	{
		try {
			xmlHttpObject = new ActiveXObject("Msxml2.XMLHTTP");
		}catch(e) 
		{
			try {
				xmlHttpObject = new ActiveXObject("Microsoft.XMLHTTP");
			}catch(e){ 
				xmlHttpObject = null;}
		}
	}

	xmlHttpObject.onreadystatechange=function()
	{
		if (xmlHttpObject.readyState==4 && xmlHttpObject.state==200)
		{
			//var obj = eval ("(" + xmlhttp.responseText + ")");
			
			speedText.innerHTML= "speed: " + xmlHttpObject.responseText; //+ "<br>dx:" + obj.dx + " dy:"+ obj.dy;
			sent="true";
		}
	}
	xmlHttpObject.open("POST","http://localhost:50000?speed="+speed+"&left="+left+"&right="+right,true);
	xmlHttpObject.send();
}


function animate(){

	requestAnimationFrame(animate);

	frameTime = clock.getDelta();


	if(	joystick.deltaY() != 0 && joystick.deltaX() != 0)
	{
		speed = -1 * joystick.deltaY() / 2.50;
		if(joystick.deltaX() > 0)
		{
			left = 100;
			right = 100 - joystick.deltaX() / 1.25;
		}
		else
		{
			right = 100;
			left = 100 + joystick.deltaX() / 1.25;
		}
	}

	if(left > 100)
		left = 100;
	else if(left < -100)
		left = -100;
		
	if(right > 100)
		right = 100;
	else if(right < -100)
		right = -100;

	if( keyboard.pressed("D")){
		if(left > -100 && left <= 100 && right == 100 )
			left -= 1;
		else if(left == 100 && right < 100 )
			right += 10;
	}
	else if( keyboard.pressed("A")){
		if(right > -100 && right <= 100 && left == 100 )
			right -= 1;
		else if(right == 100 && left < 100 )
			left += 10;
	}
	else
	{
		if(left > right)
		{
			if(left > -100 && left <= 100 && right == 100 )
				left -= 0.5;
			else if(left == 100 && right < 100 )
				right += 1;
		}
		else if(left < right)
		{
			if(right > -100 && right <= 100 && left == 100 )
				right -= 0.5;
			else if(right == 100 && left < 100 )
				left += 1;
		}
	}

	if( keyboard.pressed("W")){
		if(speed < 0)
			speed = speed + 2;
		else if(speed < 99)
			speed = speed + 1;
		else
			speed = 100;
	}
	else if( keyboard.pressed("S")){
		if(speed > 0)
			speed = speed - 2;
		else if(speed > -99)
			speed = speed - 1;
		else
			speed = -100;
	}
	else
	{
		if(speed > 2)
			speed = speed - 0.5;
		else if(speed < -2)
			speed = speed + 0.5;
		else
			speed = 0;
	}

	renderer.render( scene, camera );
	loadXMLDoc();
	
	//speedText.innerHTML =    "Frontal Speed:        " + speed;
	steeringText.innerHTML = "Steering:             " + left;
	distaheadText.innerHTML = "Free distance ahead: " + right;
	distbackText.innerHTML = "Free distance back:   " + cube.position.y.toFixed(1);

}


function onWindowResize(){
camera.aspect = window.innerWidth / window.innerHeight;
camera.updateProjectionMatrix();
renderer.setSize( window.innerWidth, window.innerHeight );
}
      </script>
   </body>
</html>
